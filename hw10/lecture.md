# Лекция #10

## Цели занятия

* Разобраться в типах индексов, плюсах и минусах;
* Cоздавать, удалять и мониторить индексы для оптимизации БД.

## Btree

В PostgreSQL B-дерево (B-tree) является одним из наиболее распространенных индексов, используемых для ускорения поиска
данных в таблицах. B-дерево представляет собой сбалансированное дерево, где каждый узел содержит несколько ключей и
указателей на поддеревья. В контексте PostgreSQL, B-дерево используется как индекс для ускорения поиска по значениям в
столбцах.

Вот несколько ключевых моментов, касающихся B-дерева в PostgreSQL:

1. **Структура B-дерева:** Узлы B-дерева в PostgreSQL содержат отсортированные ключи и соответствующие указатели на
   поддеревья. Это обеспечивает эффективность поиска, так как каждый узел дает возможность "сужать" диапазон значений,
   который нужно рассмотреть.

2. **Сортировка ключей:** Ключи в B-дереве сортируются, что ускоряет процесс поиска. Благодаря этому упорядочиванию,
   PostgreSQL может использовать алгоритмы бинарного поиска для быстрого нахождения нужного значения.

3. **Эффективность поиска:** B-дерево в PostgreSQL позволяет эффективно выполнять операции поиска, вставки и удаления
   данных. Это особенно важно для операций, связанных с индексами в базах данных.

4. **Использование в индексах:** B-дерево в PostgreSQL может быть использовано для построения индексов на отдельных
   столбцах таблицы. Индексы ускоряют поиск данных и часто используются для оптимизации запросов.

Пример создания индекса B-дерева в PostgreSQL:

```sql
CREATE INDEX idx_example ON your_table(column_name);
```

Где `idx_example` - имя индекса, `your_table` - имя таблицы, а `column_name` - имя столбца, для которого создается
индекс.

Использование B-дерева в PostgreSQL является стандартным подходом для индексации, и в большинстве случаев он
обеспечивает хорошую производительность для операций поиска и сортировки.

## GIN

GIN (Generalized Inverted Index) - это особый тип индекса в PostgreSQL, предназначенный для улучшения производительности
запросов, связанных с поиском в текстовых полях, массивах и некоторых других сложных типах данных. GIN индекс
применяется, когда данные в столбце представляют собой наборы или массивы элементов.

Вот несколько ключевых моментов, касающихся GIN индекса в PostgreSQL:

1. **Типы данных:** GIN индекс широко используется для столбцов, содержащих массивы или другие сложные типы данных,
   такие как hstore (хранилище пар ключ-значение), tsvector (вектор полнотекстового поиска) и jsonb (бинарный формат
   JSON).

2. **Полнотекстовый поиск:** Одним из наиболее распространенных применений GIN индекса является поддержка
   полнотекстового поиска. Например, столбец с типом данных tsvector может быть проиндексирован с использованием GIN для
   ускорения запросов на полнотекстовый поиск.

3. **Массивы:** GIN также часто используется для работы с массивами. Если у вас есть столбец, содержащий массивы, GIN
   индекс может значительно ускорить поиск по этим массивам.

4. **Создание индекса GIN:** Пример создания индекса GIN выглядит следующим образом:

   ```sql
   CREATE INDEX idx_example_gin ON your_table USING GIN(column_name);
   ```

   Где `idx_example_gin` - имя индекса, `your_table` - имя таблицы, а `column_name` - имя столбца, для которого
   создается индекс.

5. **Запросы с использованием GIN:** После создания индекса GIN, запросы, связанные с поиском или фильтрацией данных в
   соответствующем столбце, могут выполняться более эффективно.

GIN индекс предоставляет эффективные методы поиска и фильтрации данных в сложных типах данных, что делает его мощным
инструментом для оптимизации производительности запросов в PostgreSQL.

# GIST

GIST (Generalized Search Tree) - это ещё один тип индекса в PostgreSQL, который предназначен для работы с разнообразными
типами данных и различными методами сравнения. В отличие от B-дерева, который подходит для сравнения по порядку, GIST
обеспечивает более гибкую структуру для индексации сложных данных.

Вот несколько ключевых моментов, касающихся GIST индекса в PostgreSQL:

1. **Гибкость в типах данных:** GIST может использоваться для индексации различных типов данных, таких как
   геометрические объекты (например, точки, линии, полигоны), tsvector для полнотекстового поиска, hstore для хранения
   пар ключ-значение, и другие сложные структуры.

2. **Специфичные методы сравнения:** GIST позволяет определять специфичные методы сравнения для конкретных типов данных.
   Это позволяет индексировать данные таким образом, что учитываются их особенности и логика сравнения.

3. **Создание индекса GIST:** Пример создания индекса GIST выглядит следующим образом:

   ```sql
   CREATE INDEX idx_example_gist ON your_table USING GIST(column_name);
   ```

   Где `idx_example_gist` - имя индекса, `your_table` - имя таблицы, а `column_name` - имя столбца, для которого
   создается индекс.

4. **Географический поиск:** Один из распространенных примеров использования GIST - это географический поиск. Например,
   если у вас есть столбец с географическими данными, такими как координаты точек, GIST индекс может значительно
   ускорить запросы, связанные с поиском внутри определенной области.

GIST предоставляет богатые возможности для индексации сложных данных и спецификаций методов сравнения, что делает его
мощным инструментом для оптимизации запросов в PostgreSQL, особенно при работе с разнообразными типами данных и
нестандартными методами сравнения.

## BRIN

BRIN (Block Range INdex) - это еще один тип индекса в PostgreSQL, который предназначен для эффективной индексации
упорядоченных данных. В отличие от B-дерева, который индексирует все значения в столбце, BRIN индекс делит данные на
блоки и строит индекс, представляющий сводную информацию о каждом блоке данных.

Вот несколько ключевых моментов, касающихся BRIN индекса в PostgreSQL:

1. **Упорядоченные данные:** BRIN индекс наиболее эффективен при работе с упорядоченными данными, такими как временные
   ряды, логи и другие типы данных, которые могут быть разделены на логические блоки.

2. **Структура индекса:** BRIN индекс делит данные на блоки (обычно 8KB) и сохраняет сводную информацию о каждом блоке.
   Например, для числовых данных индекс может хранить минимальное и максимальное значение в каждом блоке.

3. **Эффективность для больших объемов данных:** BRIN индекс хорошо подходит для работы с большими объемами данных,
   когда B-дерево может столкнуться с ограничениями производительности.

4. **Создание индекса BRIN:** Пример создания индекса BRIN выглядит следующим образом:

   ```sql
   CREATE INDEX idx_example_brin ON your_table USING BRIN(column_name);
   ```

   Где `idx_example_brin` - имя индекса, `your_table` - имя таблицы, а `column_name` - имя столбца, для которого
   создается индекс.

5. **Ограничения BRIN:** Индексация BRIN может не быть подходящей для некоторых типов данных или запросов, особенно если
   данные неупорядочены. Также, она может потреблять больше места, чем B-дерево, но при этом обеспечивает хорошую
   производительность для определенных сценариев использования.

BRIN индекс представляет собой компромисс между объемом данных, скоростью запросов и производительностью при работе с
упорядоченными данными в PostgreSQL.

## Управляющие представления и функции

В PostgreSQL управляющие представления и функции - это механизмы, предоставляющие информацию о структуре базы данных, её
объектах и статистике. Эти представления и функции позволяют администраторам баз данных и разработчикам получать
полезную информацию о системе и оптимизировать её работу.

### Управляющие Представления (System Views):

1. **pg_tables:**
    - Предоставляет информацию о таблицах в базе данных, таких как их имена, владельцы и т.д.

2. **pg_indexes:**
    - Содержит информацию об индексах в базе данных, включая тип индекса, на какие таблицы он ссылается и так далее.

3. **pg_views:**
    - Содержит информацию о представлениях в базе данных, таких как их имена, владельцы, текст запроса, используемый для
      создания представления и так далее.

4. **pg_columns:**
    - Предоставляет информацию о столбцах таблиц в базе данных, включая их имена, типы данных, значения по умолчанию и
      так далее.

5. **pg_roles:**
    - Содержит информацию о ролях (пользователях и группах пользователей) в базе данных, таких как их имена, права и так
      далее.

6. **pg_stat_activity:**
    - Предоставляет информацию о текущих активных сеансах в базе данных, включая информацию о выполняемых запросах,
      времени их выполнения и т.д.

### Управляющие Функции (System Functions):

1. **pg_database_size(database_oid):**
    - Возвращает размер указанной базы данных.

2. **pg_table_size(table_oid):**
    - Возвращает размер указанной таблицы.

3. **pg_index_size(index_oid):**
    - Возвращает размер указанного индекса.

4. **pg_size_pretty(size_in_bytes):**
    - Преобразует размер в байтах в более удобочитаемый формат (КБ, МБ, ГБ и т.д.).

5. **pg_stat_reset():**
    - Сбрасывает статистику базы данных, например, статистику запросов, индексов, таблиц и так далее.

6. **pg_reload_conf():**
    - Перезагружает конфигурационные файлы PostgreSQL.

7. **pg_cancel_backend(pid):**
    - Пытается отменить выполнение запроса, выполняемого указанным процессом (pid).

Эти функции и представления предоставляют возможность детально изучать структуру базы данных, а также мониторить её
производительность. Они полезны как для администраторов, так и для разработчиков при оптимизации запросов и управлении
базой данных PostgreSQL.