# Лекция #7

## Цели занятия

* создавать и редактировать объекты БД в СУБД PostgreSQL;

## Create и alter базы данных в PostgreSQL

В PostgreSQL для создания и изменения базы данных используются SQL-команды. Вот примеры использования команд CREATE
DATABASE и ALTER DATABASE:

1. Создание базы данных (CREATE DATABASE):

Для создания новой базы данных в PostgreSQL используется следующая команда:

`CREATE DATABASE название_базы_данных;`
Например:

`CREATE DATABASE mydatabase;`
Вы можете добавить другие параметры, такие как кодировка (ENCODING), владелец (OWNER), и т.д.:

`CREATE DATABASE mydatabase
WITH
OWNER = myuser
ENCODING = 'UTF8'
LC_COLLATE = 'en_US.UTF-8'
LC_CTYPE = 'en_US.UTF-8'
TEMPLATE = template0;`

2. Изменение базы данных (ALTER DATABASE):

Для изменения параметров существующей базы данных используется команда ALTER DATABASE. Например, чтобы изменить
владельца базы данных:

`ALTER DATABASE название_базы_данных
OWNER TO новый_владелец;`
Пример:

`ALTER DATABASE mydatabase
OWNER TO newowner;`
Можно также изменять другие параметры, такие как кодировка (ENCODING), локаль (LC_COLLATE и LC_CTYPE), и т.д.

`ALTER DATABASE mydatabase
SET LC_COLLATE = 'en_US.UTF-8';`
Это основные команды для создания и изменения баз данных в PostgreSQL. Убедитесь, что у вас есть соответствующие
привилегии для выполнения этих команд, и будьте осторожны при изменении параметров баз данных, так как это может
повлиять на их работоспособность.

## Create и alter тейблспейсов в PostgreSQL

В PostgreSQL, тейблспейс (tablespace) представляет собой место для хранения данных, включая таблицы, индексы и другие
объекты базы данных. Тейблспейсы предоставляют гибкость в управлении местом хранения данных.

Вот как создавать и изменять тейблспейсы с использованием команд CREATE TABLESPACE и ALTER TABLESPACE:

1. Создание тейблспейса (CREATE TABLESPACE):

Для создания нового тейблспейса используется команда CREATE TABLESPACE:

`CREATE TABLESPACE имя_тейблспейса
LOCATION 'путь_к_тейблспейсу';`

Пример:

`CREATE TABLESPACE mytablespace
LOCATION '/путь/к/тейблспейсу';`

Параметр LOCATION указывает на директорию в файловой системе, где будут храниться данные тейблспейса.

2. Изменение тейблспейса (ALTER TABLESPACE):

Для изменения параметров тейблспейса используется команда ALTER TABLESPACE. Например, чтобы изменить расположение
тейблспейса:

`ALTER TABLESPACE имя_тейблспейса
LOCATION 'новый_путь_к_тейблспейсу';`

Пример:

`ALTER TABLESPACE mytablespace
LOCATION '/новый/путь/к/тейблспейсу';`

Также можно изменять другие параметры тейблспейса, такие как размер страницы (SET TABLESPACE mytablespace [WITH]
BLOCKSIZE = 8192;) и другие.

При изменении тейблспейса убедитесь, что база данных не использует его активно, чтобы избежать потери данных или проблем
с доступом.

Это основные команды для создания и изменения тейблспейсов в PostgreSQL. При выполнении этих операций убедитесь, что у
вас есть соответствующие привилегии, и будьте осторожны, чтобы не нарушить целостность данных.

## Create и alter пользователей и ролей в PostgreSQL

В PostgreSQL пользователи и роли являются схожими сущностями. Роль — это обобщенный термин, который включает в себя как
роли пользователей, так и группы ролей. Вот примеры команд CREATE ROLE и ALTER ROLE для создания и изменения
пользователей и ролей в PostgreSQL:

1. Создание пользователя/роли (CREATE ROLE):

Для создания нового пользователя или роли используется команда CREATE ROLE. Вы можете определить различные параметры,
такие как пароль, права доступа и т.д.

Создание пользователя с паролем:

`CREATE ROLE имя_пользователя LOGIN PASSWORD 'ваш_пароль';`

Создание роли без пароля:

`CREATE ROLE имя_роли;`

Например:

`CREATE ROLE myuser LOGIN PASSWORD 'mypassword';`

2. Изменение пользователя/роли (ALTER ROLE):

Для изменения параметров пользователя или роли используется команда ALTER ROLE. Например, чтобы изменить пароль
пользователя:

`ALTER ROLE имя_пользователя PASSWORD 'новый_пароль';`

Пример:

`ALTER ROLE myuser PASSWORD 'newpassword';`

Также можно изменять другие параметры, такие как разрешения (GRANT и REVOKE), назначение ролей в качестве
суперпользователей (SUPERUSER), ограничения по времени (VALID UNTIL), и многое другое.

Пример назначения роли в качестве суперпользователя:

`ALTER ROLE myuser SUPERUSER;`

Убедитесь, что при изменении ролей вы предоставляете необходимые права, но также будьте осторожны, чтобы не предоставить
излишних привилегий.

Это основные команды для создания и изменения пользователей/ролей в PostgreSQL. Помните, что управление пользователями и
ролями в базе данных важно для обеспечения безопасности и эффективного управления доступом к данным.

## Различных видов таблиц, в том числе временных и внешних в PostgreSQL

В PostgreSQL существует несколько видов таблиц, включая обычные (постоянные), временные и внешние таблицы.

1. Обычные (постоянные) таблицы:

Обычные таблицы - это стандартный тип таблиц, который используется для хранения постоянных данных. Они создаются с
использованием команды CREATE TABLE. Пример:

`CREATE TABLE employees (
employee_id SERIAL PRIMARY KEY,
first_name VARCHAR(50),
last_name VARCHAR(50),
salary INT
);`

Здесь employees - это обычная таблица для хранения данных о сотрудниках.

2. Временные таблицы:

Временные таблицы создаются для временного хранения данных. Они могут быть локальными (видимыми только в пределах
текущей сессии) или глобальными (видимыми для всех сессий). Временные таблицы создаются с использованием ключевого слова
TEMP или TEMPORARY:

`CREATE TEMPORARY TABLE temp_table (
...
);`
Временные таблицы могут быть полезны при выполнении сложных операций, таких как сортировка или фильтрация, когда
временное хранение данных может улучшить производительность.

3. Внешние таблицы (Foreign Tables):

Внешние таблицы позволяют обращаться к данным, хранящимся внутри или вне PostgreSQL, как если бы они были обычными
таблицами в базе данных. Это достигается с использованием Foreign Data Wrapper (FDW), который предоставляет абстракцию
для доступа к внешним данным.

Пример создания внешней таблицы с использованием FDW:

`CREATE SERVER foreign_server
FOREIGN DATA WRAPPER postgres_fdw
OPTIONS (host 'external_host', dbname 'external_db', port '5432');`

`CREATE USER MAPPING FOR current_user SERVER foreign_server OPTIONS (user 'external_user', password 'external_password');`

`CREATE FOREIGN TABLE external_table (
column1 data_type,
column2 data_type,
...
)
SERVER foreign_server
OPTIONS (table_name 'external_table');`

В этом примере external_table является внешней таблицей, предоставляющей доступ к данным внутри удаленной базы данных
через Foreign Data Wrapper.

Это основные виды таблиц в PostgreSQL, включая обычные, временные и внешние таблицы. Каждый из этих видов таблиц
обладает своими особенностями и применением в различных сценариях.

## Последовательности в PostgreSQL

В PostgreSQL, последовательности (sequences) представляют собой объекты базы данных, которые предоставляют уникальные
значения, обычно используемые для создания уникальных идентификаторов (например, для столбцов с автоматическим
увеличением). Вот как работать с последовательностями:

1. Создание последовательности (CREATE SEQUENCE):

Для создания последовательности используется команда CREATE SEQUENCE. Например:

`CREATE SEQUENCE mysequence
START 1
INCREMENT 1
MINVALUE 1
MAXVALUE 1000
CACHE 10;`

В этом примере:

mysequence - имя последовательности.
START 1 - начальное значение.
INCREMENT 1 - шаг увеличения.
MINVALUE 1 - минимальное значение.
MAXVALUE 1000 - максимальное значение.
CACHE 10 - количество значений, которые следует кэшировать.

2. Использование последовательности при вставке данных:

Последовательность можно использовать при вставке данных в таблицу для автоматического создания уникальных
идентификаторов:

`INSERT INTO mytable (id, name) VALUES (NEXTVAL('mysequence'), 'John Doe');`

Здесь NEXTVAL('mysequence') используется для получения следующего значения из последовательности mysequence и вставки
его в столбец id таблицы mytable.

3. Получение текущего значения последовательности (CURRVAL):

Если вы хотите узнать текущее значение последовательности без увеличения её значения, используйте CURRVAL:

`SELECT CURRVAL('mysequence');`

Обратите внимание, что CURRVAL можно использовать только после вызова NEXTVAL в текущей сессии.

4. Изменение значения последовательности (ALTER SEQUENCE):

Для изменения параметров последовательности используется команда ALTER SEQUENCE. Например, чтобы изменить максимальное
значение:

`ALTER SEQUENCE mysequence
MAXVALUE 2000;`

Это позволяет изменять параметры последовательности без необходимости пересоздания её.

5. Удаление последовательности (DROP SEQUENCE):

Для удаления последовательности используется команда DROP SEQUENCE:

`DROP SEQUENCE mysequence;`

После удаления последовательности связанные с ней столбцы в таблицах будут работать как обычные столбцы без
автоматического увеличения.

Это основные операции с последовательностями в PostgreSQL. Они предоставляют удобный механизм для создания уникальных
идентификаторов в базе данных.

## Представление и материализованные представления в PostgreSQL

В PostgreSQL представления (views) и материализованные представления (materialized views) предоставляют способы
абстрагирования и структурирования данных для более удобного доступа и использования. Вот как они работают:

### Представления (Views):

1. Создание представления (CREATE VIEW):

Для создания представления используется команда CREATE VIEW. Представление является виртуальным объектом, представляющим
собой запрос, который можно использовать так, как если бы это была таблица.

`CREATE VIEW myview AS
SELECT column1, column2
FROM mytable
WHERE condition;`

2. Использование представления:

После создания представления, вы можете использовать его в запросах, как если бы это была обычная таблица:

`SELECT * FROM myview;`

Представления обновляются динамически при выполнении запросов к ним, отражая текущее состояние базы данных.

### Материализованные представления (Materialized Views):

1. Создание материализованного представления (CREATE MATERIALIZED VIEW):

В отличие от обычных представлений, материализованные представления хранят результат запроса как реальные данные. Это
может быть полезно, если требуется сохранять снимки данных для более эффективного выполнения сложных запросов.

`CREATE MATERIALIZED VIEW mymaterializedview AS
SELECT column1, column2
FROM mytable
WHERE condition;`

2. Обновление материализованного представления (REFRESH):

Материализованные представления не обновляются динамически при каждом запросе. Для обновления данных в материализованном
представлении используется команда REFRESH.

`REFRESH MATERIALIZED VIEW mymaterializedview;`

3. Использование материализованного представления:

После создания и обновления материализованного представления, вы можете использовать его в запросах точно так же, как и
обычное представление.

`SELECT * FROM mymaterializedview;`

Материализованные представления особенно полезны, когда необходимо оптимизировать производительность сложных запросов за
счет сохранения результатов вместо их повторного выполнения при каждом запросе.

Оба типа представлений имеют свои собственные преимущества и недостатки, и выбор между ними зависит от конкретных
потребностей и требований вашего приложения.