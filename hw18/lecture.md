# Лекция #18

## Репликация

## Цели занятия

создать реплику базы;
сделать ручное переключение ролей;
переключиться после фэйловера;
настроить архивацию логов;

## Принципы работы репликации;

Репликация в PostgreSQL позволяет создавать копии данных с одного сервера (или узла) на другой, обеспечивая высокую доступность, распределение нагрузки или резервное копирование. Вот основные принципы работы репликации в PostgreSQL:

1. **Типы репликации**:
    - **Логическая репликация**: В этом режиме данные отправляются в виде изменений (транзакционных записей) и применяются на реплику. Этот тип репликации введен в PostgreSQL начиная с версии 10.
    - **Физическая репликация**: Здесь данные отправляются в виде бинарных записей (WAL-файлов) и применяются на реплику. Это стандартный метод репликации, доступный в PostgreSQL с ранних версий.

2. **Потоковая репликация**: Один сервер отправляет изменения (транзакционные данные или WAL-файлы) другому серверу в реальном времени. Это может быть синхронной или асинхронной.

3. **Асинхронная репликация**: При асинхронной репликации основной сервер продолжает работу независимо от статуса реплики. Это может привести к небольшой задержке между моментом записи на основном сервере и её применением на реплике.

4. **Синхронная репликация**: При синхронной репликации запись на основном сервере не считается завершенной, пока не будет подтверждена применением изменений на реплике. Это обеспечивает гарантии целостности данных, но может снизить производительность из-за ожидания подтверждения от реплики.

5. **Hot Standby**: PostgreSQL позволяет использовать реплику для чтения данных в режиме только для чтения (read-only), даже если основной сервер недоступен. Это позволяет распределять нагрузку на чтение и обеспечивать высокую доступность для приложений, которые могут обойтись без записи.

6. **WAL (Write-Ahead Logging)**: Физическая репликация в PostgreSQL основана на WAL-логах. Это механизм журналирования, который записывает все изменения данных перед их фактическим применением. Реплика использует эти WAL-файлы для восстановления и применения изменений на стороне реплики.

7. **Слоты репликации**: Это механизм в PostgreSQL, который позволяет основному серверу хранить WAL-файлы для реплики, даже если реплика временно отключена. Это упрощает управление и обеспечивает надежность репликации.

Для настройки репликации в PostgreSQL обычно используются инструменты, такие как `pg_basebackup`, `pg_dump`, `pg_restore`, а также параметры конфигурации PostgreSQL и файл `recovery.conf` на стороне реплики.

## Типы репликации: синхронная, асинхронная, полусинхронная;

В PostgreSQL существуют различные методы репликации, которые можно классифицировать по типу синхронности передачи данных. Вот основные типы репликации с их особенностями:

1. **Синхронная репликация**:
   - При использовании синхронной репликации запись на основном сервере не считается завершенной, пока не будет подтверждена применением изменений на реплике.
   - Это гарантирует, что при сбое основного сервера на реплике будет точное копирование данных, так как изменения будут применены сразу и в том же порядке.
   - Однако этот тип репликации может снизить производительность, так как каждая транзакция будет ждать подтверждения от реплики.

2. **Асинхронная репликация**:
   - При асинхронной репликации основной сервер продолжает работу независимо от статуса реплики. Изменения на реплику передаются в асинхронном режиме, без ожидания подтверждения.
   - Это позволяет увеличить производительность на основном сервере, так как нет необходимости ждать подтверждения от реплики.
   - Однако в случае сбоя основного сервера небольшие изменения могут быть потеряны, так как они могут не успеть примениться на реплике.

3. **Полусинхронная репликация**:
   - Полусинхронная репликация сочетает особенности синхронной и асинхронной репликации. Основной сервер продолжает работу после записи транзакции, но ожидает подтверждение от хотя бы одной реплики перед тем, как считать транзакцию полностью завершенной.
   - Этот тип репликации предоставляет баланс между гарантиями целостности данных и производительностью.
   - Полусинхронная репликация часто используется в сценариях, где требуется высокая доступность и надежность, но при этом можно принимать некоторые компромиссы в производительности.

Для настройки и управления различными типами репликации в PostgreSQL можно использовать различные инструменты и параметры конфигурации, такие как `synchronous_standby_names` для синхронной репликации или различные параметры в `recovery.conf` для асинхронной репликации.

## Практическая настройка репликации;

Настройка репликации в PostgreSQL может быть сложной задачей, требующей глубокого понимания архитектуры базы данных и конфигурационных параметров. Вот базовый план и рекомендации для практической настройки репликации в PostgreSQL:

1. **Подготовка серверов**:
   - Убедитесь, что оба сервера (основной и реплика) имеют одинаковую версию PostgreSQL.
   - Настройте сетевые параметры для обеспечения безопасного и быстрого обмена данными между серверами.

2. **Выбор типа репликации**:
   - Определите, какой тип репликации (синхронный, асинхронный или полусинхронный) соответствует вашим требованиям.

3. **Настройка основного сервера**:
   - Включите WAL (Write-Ahead Logging) в конфигурации.
   - Установите параметры для репликации в `postgresql.conf`, например, `wal_level`, `max_wal_senders`, и `wal_keep_segments`.
   - Создайте слот репликации с помощью команды `CREATE_REPLICATION_SLOT`.

4. **Настройка реплики**:
   - Используйте инструменты, такие как `pg_basebackup` или `pg_dump`, для создания начальной копии данных на реплике.
   - Настройте файл `recovery.conf` на реплике, указав параметры подключения к основному серверу и слот репликации.

5. **Тестирование репликации**:
   - Запустите реплику и убедитесь, что данные синхронизированы и реплика корректно применяет изменения с основного сервера.
   - Проведите тесты на отказоустойчивость, проверив работу при сбоях и восстановлениях.

6. **Мониторинг и обслуживание**:
   - Настройте мониторинг состояния репликации с помощью инструментов или сторонних решений.
   - Регулярно проверяйте состояние репликации и производительность системы.
   - Проводите регулярное обслуживание, включая очистку WAL-файлов и проверку целостности данных.

7. **Управление репликацией**:
   - При необходимости добавляйте дополнительные реплики или изменяйте параметры репликации.
   - Учитывайте ограничения производительности и надежности при изменении типа или конфигурации репликации.

При настройке репликации важно тщательно тестировать каждый этап и учитывать специфические требования вашего приложения и инфраструктуры. Также рекомендуется обращаться к официальной документации PostgreSQL и использовать проверенные методы и рекомендации сообщества для обеспечения стабильной и надежной работы репликации.

## Параметры конфигурации для настройки;

Настройка PostgreSQL с помощью параметров конфигурации позволяет оптимизировать производительность, управлять ресурсами и адаптировать систему под конкретные требования вашего приложения или инфраструктуры. Вот некоторые ключевые параметры конфигурации для настройки PostgreSQL:

1. **Основные параметры**:
   - **`listen_addresses`**: Указывает на IP-адреса и порты, на которых сервер PostgreSQL будет слушать подключения.
   - **`port`**: Задает порт, на котором сервер PostgreSQL будет прослушивать подключения.
   - **`max_connections`**: Максимальное количество одновременных подключений к серверу.

2. **Параметры памяти и кэширования**:
   - **`shared_buffers`**: Количество памяти, выделенной для кэширования данных в оперативной памяти.
   - **`work_mem`**: Максимальный объем памяти, который может использоваться для внутренних операций сортировки и хеш-соединений.
   - **`maintenance_work_mem`**: Максимальный объем памяти для операций обслуживания и VACUUM.
   - **`effective_cache_size`**: Приблизительный размер доступного кэша на уровне операционной системы.

3. **Параметры журналирования и репликации**:
   - **`wal_level`**: Уровень журналирования WAL (Write-Ahead Logging).
   - **`archive_mode`** и **`archive_command`**: Параметры для настройки архивного режима и команды архивации WAL-файлов.
   - **`max_wal_senders`** и **`wal_keep_segments`**: Параметры для настройки потоковой репликации и хранения WAL-файлов для реплики.

4. **Параметры оптимизации запросов**:
   - **`random_page_cost`** и **`seq_page_cost`**: Оценки стоимости случайного и последовательного доступа к данным.
   - **`default_statistics_target`**: Количество строк, используемых для оценки статистики при планировании запросов.

5. **Параметры безопасности и аутентификации**:
   - **`ssl`**: Включение SSL/TLS для защищенных подключений.
   - **`password_encryption`**: Метод шифрования паролей.
   - **`pg_hba.conf`**: Файл настройки для определения прав доступа и методов аутентификации.

6. **Параметры логирования и мониторинга**:
   - **`logging_collector`**, **`log_directory`**, и **`log_filename`**: Настройки для сбора и хранения журналов.
   - **`log_statement`**: Уровень детализации логирования SQL-запросов.

7. **Параметры производительности и оптимизации**:
   - **`checkpoint_timeout`** и **`checkpoint_completion_target`**: Параметры для настройки автоматических контрольных точек.
   - **`autovacuum`**: Включение и настройка автоматического обслуживания таблиц.

Это лишь некоторые из множества доступных параметров конфигурации PostgreSQL. При настройке рекомендуется тщательно изучить официальную документацию PostgreSQL и учитывать специфику вашей системы, требования приложения и доступные ресурсы. Также рекомендуется проводить тестирование и мониторинг для оценки влияния изменений на производительность и стабильность работы системы.

## Потоковая и архивная репликации.

В PostgreSQL существует два основных метода репликации: потоковая (streaming replication) и архивная (log shipping). Оба этих метода предоставляют способы создания резервных копий данных и обеспечивают высокую доступность, но они имеют разные особенности и применяются в различных сценариях.

1. **Потоковая репликация (Streaming Replication)**:
   - **Принцип работы**: В потоковой репликации основной сервер (мастер) передает изменения в реальном времени (WAL-файлы) на одну или несколько реплик (стандбай серверов).
   - **Преимущества**:
      - Высокая степень надежности и согласованности данных.
      - Минимальная задержка между основным сервером и репликами.
      - Возможность использования для чтения (только для чтения) на репликах (Hot Standby).
   - **Ограничения**:
      - Все реплики являются полными копиями основного сервера, что может потребовать значительных ресурсов.
      - Необходимо тщательно контролировать и мониторить состояние репликации.

2. **Архивная репликация (Log Shipping)**:
   - **Принцип работы**: В архивной репликации основной сервер (мастер) регулярно архивирует WAL-файлы и передает их на реплику (стандбай сервер), который восстанавливает данные из этих архивных файлов.
   - **Преимущества**:
      - Эффективное использование ресурсов, так как реплика обновляется не в реальном времени.
      - Возможность задержки применения изменений на реплике (лаг репликации), что может быть полезно в некоторых сценариях.
      - Гибкость в настройке и управлении, включая возможность установки различных версий PostgreSQL на мастере и реплике.
   - **Ограничения**:
      - Большая задержка между основным сервером и репликой по сравнению с потоковой репликацией.
      - Необходимость регулярно архивировать WAL-файлы и передавать их на реплику.
      - Ограниченная возможность использования реплики для чтения без дополнительных настроек.

Выбор между потоковой и архивной репликацией зависит от конкретных требований вашего приложения и инфраструктуры. Потоковая репликация обычно предпочтительна для сценариев, требующих высокой доступности и минимальной задержки между серверами. Архивная репликация может быть более гибким решением для сценариев с ограниченными ресурсами или требующих задержки в обновлении реплики.