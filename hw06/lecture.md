# Лекция #6

## Внутренняя архитектура СУБД PostgreSQL

## Цели занятия

* Иметь представления об устройстве СУБД PostgreSQL;
* Установить СУБД PostgreSQL;
* Создать базу данных и подключаться к ней;

### Обслуживающие процессы в PostgreSQL

PostgreSQL — это мощная система управления реляционными базами данных с открытым исходным кодом. Обслуживающие процессы
в PostgreSQL выполняют различные задачи, направленные на обеспечение надежности, производительности и целостности
данных. Вот несколько ключевых обслуживающих процессов в PostgreSQL:

1. Postmaster (постмастер): Это главный процесс PostgreSQL, который управляет всеми другими процессами. Он отвечает за
   прослушивание новых запросов от клиентов, управление процессами-потомками, обработку подключений и контроль
   целостности базы данных.

2. Background Writer (BGW): Этот процесс отвечает за асинхронную запись грязных (измененных) страниц из памяти на диск.
   Это повышает производительность, так как он позволяет избегать блокировки процесса сервера во время операций записи.

3. Checkpointer: Checkpointer периодически записывает данные из буферного кэша на диск. Это снижает время восстановления
   базы данных после аварийного завершения работы сервера.

4. Autovacuum (автовакуум): Этот процесс отвечает за автоматическое управление пространством и поддержание целостности
   данных. Он удаляет устаревшие кортежи, освобождает место после операций удаления, обновления и вставки, а также
   выполняет анализ структуры таблиц для оптимизации запросов.

5. WalWriter и WalReceiver: Write-Ahead Logging (WAL) — это механизм, который записывает изменения данных до их
   фактической записи в таблицы. WalWriter отвечает за запись WAL-файлов, а WalReceiver — за восстановление данных в
   репликах (в режиме стриминга репликации).

6. Statistics Collector (статистический сборщик): Этот процесс собирает статистику о запросах, активности и
   использовании
   ресурсов сервером. Эти данные могут быть полезными для мониторинга производительности и оптимизации запросов.

7. Archiver (архиватор): Если включена архивация WAL, то этот процесс отвечает за копирование WAL-файлов в архив, что
   позволяет восстанавливать базу данных до конкретного момента времени.

Все эти процессы работают совместно для обеспечения эффективной и надежной работы PostgreSQL. Понимание и управление
этими процессами важны для оптимизации производительности и обеспечения стабильности базы данных.

### Управление памятью в PostgreSQL

Управление памятью в PostgreSQL играет ключевую роль в обеспечении эффективной работы системы. PostgreSQL использует
буферный кэш, который хранит данные из таблиц в оперативной памяти для ускорения доступа к ним. Вот несколько ключевых
аспектов управления памятью в PostgreSQL:

1. Буферный кэш (shared_buffers): Это параметр конфигурации, определяющий количество памяти, выделенной для буферного
   кэша. Буферный кэш содержит данные, считанные из таблиц, и предназначен для уменьшения обращений к диску. Оптимальный
   размер буферного кэша зависит от размера базы данных и характеристик запросов.

2. Effective Cache Size (effective_cache_size): Этот параметр также используется для оптимизации запросов. Он указывает
   PostgreSQL на размер кэша вне буферного кэша, который может использоваться для кэширования данных. PostgreSQL
   использует этот параметр для принятия решений о планах выполнения запросов.

3. Механизм предварительного выделения памяти (preallocations): PostgreSQL использует механизм предварительного
   выделения памяти, чтобы избежать фрагментации. Это означает, что при старте PostgreSQL резервирует большое количество
   памяти, которое впоследствии используется по мере необходимости.

4. Автоматическое высвобождение памяти (automatic memory freeing): PostgreSQL умеет освобождать память автоматически в
   случае, если ей нужно больше места для других нужд. Это включает в себя высвобождение неиспользуемых кэшей и
   временных структур данных.

5. Работа с конфигурационными параметрами: Помимо вышеупомянутых параметров, PostgreSQL предоставляет множество других
   параметров конфигурации, которые позволяют настроить использование памяти в соответствии с конкретными требованиями
   системы. Например, параметры work_mem и maintenance_work_mem используются для управления объемом памяти, выделяемым
   для сортировки и обслуживания базы данных соответственно.

6. Monitoring and Tuning (мониторинг и настройка): Постоянный мониторинг использования памяти и выполнение
   профилирования запросов помогут выявить проблемы и оптимизировать конфигурацию PostgreSQL для лучшей
   производительности.

Важно отметить, что эффективное управление памятью зависит от характеристик конкретной системы и нагрузки на базу
данных. Регулярное мониторинг и настройка параметров памяти помогут достичь оптимальной производительности PostgreSQL.

### Буферы данных, буферы журналов в PostgreSQL

В PostgreSQL буферы данных и буферы журналов (WAL-буферы) играют важную роль в обеспечении целостности данных и
ускорении операций в базе данных. Давайте рассмотрим каждый тип буферов более подробно:

1. Буферы данных (shared_buffers):

    * Определение: Буферы данных представляют собой область оперативной памяти, в которой кэшируются данные из таблиц
      базы данных. PostgreSQL использует механизм кэширования для уменьшения обращений к диску и улучшения
      производительности путем предоставления быстрого доступа к данным, которые могут быть часто запрошены.
    * Конфигурация: Размер буферного кэша определяется параметром shared_buffers в конфигурационном файле PostgreSQL.
      Этот параметр указывает количество памяти в килобайтах, выделенное для буферного кэша.

2. Буферы журналов (WAL-буферы):

    * Определение: Журналирование с предварительной записью (Write-Ahead Logging, WAL) — это механизм, который
      гарантирует целостность данных в случае сбоев системы. В WAL-буферах хранятся записи журнала, содержащие
      информацию об изменениях данных, произведенных в транзакциях, перед их фактической записью на диск. Это
      обеспечивает возможность восстановления данных после сбоев.
    * WAL-буферы vs Буферы данных: Буферы данных хранят сами данные, тогда как WAL-буферы содержат записи журнала,
      которые описывают изменения. WAL-буферы используются для записи изменений до того, как они будут применены к
      фактическим данным.
    * Конфигурация: Размер WAL-буферов настраивается параметром wal_level (уровень журнала) и параметром wal_buffers (
      количество WAL-буферов).
    * Оба типа буферов важны для обеспечения надежности и производительности PostgreSQL. Когда приходит запрос на
      изменение данных, PostgreSQL сначала записывает соответствующую информацию в WAL-буферы, а затем в буферы данных.
      Такой подход обеспечивает атомарность, согласованность и изоляцию транзакций (ACID-свойства), а также позволяет
      восстанавливать
      данные после сбоев.

### WAL в PostgreSQL

WAL, или Write-Ahead Logging (журналирование с предварительной записью), представляет собой ключевую технологию в
PostgreSQL и других системах управления базами данных. Она обеспечивает надежность и целостность данных, а также
позволяет восстановление базы данных после сбоев. Давайте рассмотрим основные аспекты WAL в PostgreSQL:

1. Цель WAL

    * Надежность данных: WAL обеспечивает надежность данных, записывая изменения в журнал до того, как они будут
      применены к фактическим данным на диске. Это гарантирует, что данные не будут потеряны в случае сбоев или отказов
      системы.
    * Восстановление после сбоев: Записи в WAL позволяют восстановить базу данных до конкретного момента времени или до
      конкретной транзакции, что особенно важно при восстановлении после аварийного завершения работы сервера.

2. Структура WAL

    * Записи в WAL представляют собой последовательные блоки данных, содержащих информацию о всех изменениях данных.
    * Каждая запись WAL обычно включает информацию о начале и завершении транзакции, изменениях в данных, информацию о
      точке восстановления и другие метаданные.

3. Уровни журналирования (wal_level):

    * PostgreSQL позволяет настроить уровень журналирования. Высокий уровень журналирования включает в себя больше
      информации о транзакциях и изменениях, что может быть полезно для репликации и восстановления.
    * Уровни журналирования включают minimal, replica, и logical.

4. WAL-буферы и WAL-архивация:

    * WAL-буферы: PostgreSQL использует специальные буферы (WAL-буферы), чтобы хранить записи журнала до их фактической
      записи на диск. Размер WAL-буферов может быть настроен с помощью параметра wal_buffers.
    * WAL-архивация: В режиме WAL-архивации, записи журнала также сохраняются в архивных журналах, что позволяет
      восстанавливать базу данных до любого момента времени.

5. Процесс записи WAL:

    * При каждой транзакции записи журнала создаются для всех изменений данных.
    * Записи WAL-журнала сначала записываются в специальные буферы (WAL-буферы) в памяти.
    * После этого они сбрасываются на диск в соответствии с конфигурацией и уровнем журналирования.

6. Восстановление из WAL:

    * При восстановлении базы данных после сбоя, PostgreSQL использует записи журнала для воссоздания изменений, которые
      могли быть утеряны.
    * Восстановление может быть точечным (до определенного момента времени) или до конкретной транзакции.

WAL в PostgreSQL обеспечивает уровень долговечности и целостности данных, делая систему надежной и готовой к
восстановлению после сбоев. Это важное свойство для широкого спектра приложений, особенно тех, где требуется высокая
степень надежности и восстанавливаемости данных.