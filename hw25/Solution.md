# Домашнее задание

Транзакции

## Цель:

* Заполнение своего проекта данными

## Описание/Пошаговая инструкция выполнения домашнего задания:

* Описать пример транзакции из своего проекта с изменением данных в нескольких таблицах. Реализовать в виде хранимой
  процедуры.
* Загрузить данные из приложенных в материалах csv.
* Реализовать следующими путями:
* LOAD DATA

* Задание со *: загрузить используя mysqlimport

## Критерии оценки:

Выполнение ДЗ: 10 баллов
плюс 2 балла за красивое решение
минус 2 балла за рабочее решение, и недостатки указанные преподавателем не устранены

## Решение:

Транзакция в рамке которой происходит выдача работнику одной позиции хранящийся на складе.

```SQL
START TRANSACTION;

-- Задаем значения переменных (предположим, у вас есть соответствующий item_id и worker_id)
SET @item_id = 2; -- ID товара, который выдается
SET @worker_id = 1; -- ID работника, которому выдается товар
SET @operation_id = 1;
-- ID операции (например, "Выдача")

-- 1. Добавление записи в таблицу item_history
INSERT INTO OTUS_DB_MYSQL.item_history
    (fk_operation, fk_item, fk_worker, `time`)
VALUES (@operation_id, @item_id, @worker_id, NOW());

-- Получаем ID последней добавленной записи в item_history
SET @item_history_id = LAST_INSERT_ID();

-- 2. Изменение статуса Item
UPDATE OTUS_DB_MYSQL.item
SET fk_status = (SELECT id FROM OTUS_DB_MYSQL.status WHERE name = 'issued')
WHERE id = @item_id;

-- Если все операции успешно выполнены, фиксируем транзакцию
COMMIT;

```

### [Docker-compose](../docker/mysql/docker-compose.yml)

Чтобы загрузить данные из CSV-файла в таблицу `worker` в MySQL, нужно выполнить следующие шаги:

1. **Подготовка**: Убедитесь, что структура таблицы `worker` в MySQL соответствует структуре нашего CSV-файла.
   Сравните количество столбцов и их типы данных.

2. **Загрузка данных**: Используем команду `LOAD DATA INFILE` для загрузки данных из CSV-файла в таблицу. Пример:

```sql
LOAD DATA INFILE '/path_to_your_file.csv'
    INTO TABLE worker
    FIELDS TERMINATED BY ','
    LINES TERMINATED BY '\n'
    IGNORE 1 ROWS; -- если первая строка в CSV является заголовком
```

**Пример с параметрами**:

Предположим, у вас есть CSV-файл `workers.csv`, который вы хотите импортировать в таблицу `worker` с
полями `id`, `first_name`, `middle_name`, `last_name`, `phone`, и `fk_post`.

Структура `workers.csv` может выглядеть так:

```
id,first_name,middle_name,last_name,phone,fk_post
1,Иван,Иванович,Иванов,+7(123)456-7890,1
2,Петр,Петрович,Петров,+7(123)456-7891,2
3,Сергей,Сергеевич,Сергеев,+7(123)456-7892,3
```

Тогда ваш SQL-запрос будет выглядеть так:

```sql
LOAD DATA INFILE '/path_to_your_file/workers.csv'
    INTO TABLE worker
    FIELDS TERMINATED BY ','
    LINES TERMINATED BY '\n'
    IGNORE 1 ROWS;
```

**Важные замечания**:

- Необходимо убедитесь, что у пользователя базы данных MySQL, который вы используете для импорта, есть соответствующие разрешения
  на чтение файла.
- Путь к файлу (`/path_to_your_file.csv`) должен быть абсолютным или относительным от местоположения сервера MySQL, а не
  от местоположения вашего клиента.
- Если мы импортируете большой CSV-файл, убедитесь, что наша конфигурация MySQL позволяет загружать такие файлы. В
  некоторых случаях могут потребоваться дополнительные настройки, такие как увеличение значения `max_allowed_packet`.
 
`mysqlimport` — это инструмент командной строки, который предоставляется MySQL и предназначен для быстрой загрузки данных из текстовых файлов (обычно CSV-файлов) в таблицы MySQL.

Чтобы использовать `mysqlimport` для загрузки данных в таблицу `worker`, выполните следующие шаги:

1. **Подготовка**: Убедитесь, что у вас есть соответствующий CSV-файл для импорта и что его структура соответствует структуре таблицы `worker` в вашей базе данных MySQL.

2. **Запуск mysqlimport**:

Откройте терминал или командную строку и используйте следующую команду:

```bash
mysqlimport --local -u [username] -p [database_name] /path_to_your_file/workers.csv
```

Здесь:
- `--local`: указывает, что файл находится на локальной машине.
- `-u [username]`: замените `[username]` на ваше имя пользователя MySQL.
- `-p`: после ввода этой опции система запросит вас ввести пароль.
- `[database_name]`: замените на имя вашей базы данных MySQL.
- `/path_to_your_file/workers.csv`: путь к вашему CSV-файлу.

После выполнения команды `mysqlimport` запросит у вас пароль для пользователя MySQL. Введите пароль, и данные из CSV-файла будут загружены в таблицу `worker` вашей базы данных.

```bash
mysqlimport --fields-terminated-by=',' -u root -p OTUS_DB_MYSQL ./../../../worker.csv
```
[Результат](result.png)

