# Лекция #25

## Транзакции, MVCC, ACID

## Цели занятия

* разбираться в уровнях изоляции транзакций;
* избегать взаимных блокировок;
* разбираться в различных видах блокировок;
* строить транзакции в mysql;

### определение транзакции;

В контексте MySQL транзакция представляет собой последовательность одного или нескольких SQL-операторов, которые выполняются как единое целое. Транзакции используются для группировки операций в базе данных, чтобы гарантировать, что либо все операции будут успешно завершены, либо ни одна из них не будет выполнена.

Основные понятия и особенности транзакций в MySQL:

1. **ACID**:
    - **A (Atomicity)**: Транзакция считается атомарной. Это означает, что все операции в транзакции должны быть выполнены успешно. Если одна из операций не выполнена, все изменения отменяются (rollback).
    - **C (Consistency)**: Транзакция переводит базу данных из одного состояния в другое, соблюдая все ограничения целостности.
    - **I (Isolation)**: Каждая транзакция работает изолированно от других транзакций, что гарантирует, что операции одной транзакции не влияют на операции другой транзакции.
    - **D (Durability)**: После того как транзакция была успешно завершена, ее изменения сохраняются даже в случае сбоя системы.

2. **Команды управления транзакциями**:
    - `START TRANSACTION`: Начать новую транзакцию.
    - `COMMIT`: Завершить текущую транзакцию и сохранить все изменения.
    - `ROLLBACK`: Откатить текущую транзакцию и отменить все изменения.

3. **Точки сохранения (Savepoints)**: В MySQL можно устанавливать точки сохранения внутри транзакции с помощью команды `SAVEPOINT`. Это позволяет откатывать часть транзакции до определенной точки, минуя предыдущие операции.

4. **Автоматическое управление транзакциями**: В зависимости от конфигурации MySQL может автоматически начинать транзакции при выполнении первой операции и автоматически коммитить их после выполнения или откатывать их при ошибке.

Важно правильно использовать транзакции в MySQL, чтобы гарантировать целостность данных и предотвратить потерю данных в случае сбоев или ошибок.

### ACID;

ACID — это аббревиатура, которая описывает основные свойства, которые должны обеспечиваться в системах управления базами данных (СУБД) для обеспечения надежности транзакций. Рассмотрим каждый из этих свойств подробнее в контексте MySQL:

1. **A (Atomicity) — Атомарность**:
    - Это означает, что транзакция считается атомарной и либо полностью выполняется успешно, либо не выполняется вообще.
    - Если транзакция была начата, но в процессе выполнения произошла ошибка или сбой, то все изменения, сделанные этой транзакцией до момента ошибки, откатываются (или "отменяются").
    - В MySQL, если не используется явный коммит или откат, большинство операций транзакций автоматически завершаются командой COMMIT или ROLLBACK.

2. **C (Consistency) — Согласованность**:
    - Это гарантия того, что база данных находится в консистентном состоянии до и после выполнения транзакции.
    - Транзакции в MySQL обеспечивают соблюдение всех ограничений целостности, определенных на уровне схемы базы данных, например, уникальности ключей или ссылочной целостности.

3. **I (Isolation) — Изолированность**:
    - Гарантирует, что каждая транзакция работает изолированно от других транзакций.
    - Это предотвращает взаимное влияние операций разных транзакций на результат выполнения друг друга, что может привести к "грязному чтению", "неповторяющемуся чтению" или "фантомному чтению".
    - В MySQL уровень изоляции транзакций может быть установлен с помощью команды `SET TRANSACTION ISOLATION LEVEL`.

4. **D (Durability) — Долговечность**:
    - Означает, что после успешного завершения транзакции ее результаты остаются устойчивыми в системе и сохраняются даже в случае сбоев или перезагрузки.
    - В MySQL это обеспечивается благодаря журнализации (логированию) операций. Когда транзакция фиксируется (коммитится), ее изменения записываются в журнал (лог) транзакций, что гарантирует возможность восстановления данных в случае сбоя.

Все эти

свойства обеспечивают надежность и предсказуемость поведения транзакций в системах управления базами данных, включая MySQL. Использование транзакций с поддержкой ACID-свойств помогает обеспечивать целостность данных и предотвращать потерю или искажение информации.

### MVCC;

MVCC (Multi-Version Concurrency Control) — это механизм управления параллелизмом, который позволяет одновременно выполнять множество транзакций в системе управления базами данных (СУБД), не блокируя друг друга. Он обеспечивает высокую степень изоляции для транзакций и позволяет СУБД предоставлять каждой транзакции свою "версию" данных, с которыми она работает.

Рассмотрим основные аспекты MVCC в контексте MySQL:

1. **Версионирование данных**:
    - При каждом изменении строки в таблице MySQL создает новую версию этой строки. Эта версия содержит информацию о том, когда и как она была изменена.
    - Каждая транзакция воспринимает данные в состоянии, которое было актуально на момент ее начала. Это обеспечивает изоляцию транзакций друг от друга.

2. **Read View (Чтение версии)**:
    - Когда транзакция начинает чтение данных, ей присваивается "view" (или "снимок") состояния базы данных на момент начала транзакции. Этот view определяет, какие строки и какие версии строк должны быть видны транзакции.
    - Этот механизм гарантирует, что транзакции, работающие параллельно, не будут блокировать друг друга при чтении данных.

3. **Garbage Collection**:
    - Со временем некоторые версии строк становятся устаревшими и больше не нужны для поддержания изоляции транзакций. В таких случаях MySQL может удалить эти устаревшие версии, освобождая место в базе данных.

4. **Журналирование и MVCC**:
    - MVCC работает в тесной связке с журналированием (логированием) операций. Журнал транзакций позволяет восстановить состояние базы данных после сбоев и гарантирует долговечность (одно из свойств ACID) транзакций.

Преимущества MVCC в MySQL:

- Высокая производительность при одновременном выполнении множества транзакций, так как нет блокировок на чтение данных.
- Улучшенная изоляция транзакций, что минимизирует конфликты и повышает эффективность работы приложений.
- Возможность предоставления "снимков" данных для конкретных транзакций, что обеспечивает предсказуемость и надежность работы с данными.

В заключение, MVCC является ключевой технологией, обеспечивающей высокую производительность и надежность работы MySQL в многопользовательской среде с параллельным выполнением транзакций.

### аномалии;

В контексте баз данных, аномалии являются нежелательными и неожиданными ситуациями, которые могут возникать при выполнении операций чтения и записи. Аномалии могут нарушать предполагаемую целостность данных или приводить к некорректным результатам запросов. Вот несколько типичных аномалий в MySQL и других системах управления базами данных:

1. **Аномалия вставки (Insert Anomaly)**:
    - Возникает, когда для вставки новой записи в таблицу требуется добавить несвязанную информацию.
    - Например, при попытке добавить информацию о новом студенте в таблицу студентов, но в связанной таблице оценок еще нет соответствующей записи для этого студента.

2. **Аномалия обновления (Update Anomaly)**:
    - Возникает, когда изменение данных в одной таблице приводит к необходимости изменения данных в другой таблице, но это не происходит.
    - Например, если в таблице студентов изменяется номер группы, но в таблице групп этот номер не обновляется соответствующим образом.

3. **Аномалия удаления (Deletion Anomaly)**:
    - Возникает, когда удаление данных из одной таблицы приводит к потере связанных данных из другой таблицы.
    - Например, при удалении информации о студенте из таблицы студентов, связанные с ним данные в таблице оценок также могут быть непреднамеренно удалены.

4. **Аномалия дублирования (Redundancy Anomaly)**:
    - Возникает, когда одни и те же данные хранятся в нескольких местах, что может привести к несоответствию или противоречию информации.
    - Например, если информация о группе и ее руководителе дублируется в разных таблицах, и в одной из таблиц эти данные обновляются, но в другой нет.

Чтобы предотвратить аномалии в MySQL (и других СУБД), разработчики и администраторы баз данных должны тщательно проектировать структуру базы данных, определять связи между таблицами с использованием внешних ключей и следовать принципам нормализации данных. Нормализация помогает избежать избыточности данных и обеспечивает целостность и соответствие данных в базе данных.

### уровни изоляции;

Уровни изоляции в системах управления базами данных (СУБД), включая MySQL, определяют, насколько транзакции изолированы друг от друга. Это влияет на то, как транзакции взаимодействуют с данными и какие феномены параллелизма могут возникнуть. В MySQL можно установить различные уровни изоляции с помощью команды `SET TRANSACTION ISOLATION LEVEL`.

Вот основные уровни изоляции в MySQL:

1. **READ UNCOMMITTED (Неизолированное чтение)**:
    - Этот уровень предполагает минимальную изоляцию. Транзакция может читать строки, которые были изменены другими транзакциями, но еще не зафиксированы.
    - Это может привести к "грязному чтению", когда одна транзакция читает данные, которые могут быть отклонены или изменены другой транзакцией.

2. **READ COMMITTED (Чтение фиксированной коммитности)**:
    - Этот уровень гарантирует, что транзакция читает только те данные, которые уже были зафиксированы другими транзакциями.
    - Это решает проблему "грязного чтения", но все еще может приводить к "неповторяющемуся чтению" и "фантомному чтению".

3. **REPEATABLE READ (Повторяемое чтение)**:
    - Этот уровень гарантирует, что если одна транзакция читает данные, то другая транзакция не может изменить или удалить эти данные до тех пор, пока первая транзакция не завершится.
    - Это предотвращает "неповторяющееся чтение", но может все еще приводить к "фантомному чтению", когда одна транзакция читает разное количество строк в разные моменты времени.

4. **SERIALIZABLE (Сериализуемое чтение)**:
    - Этот уровень предоставляет максимальную изоляцию. Он гарантирует, что результаты операций чтения и записи транзакции не влияют на результаты других транзакций.
    - Это решает проблемы "грязного чтения", "неповторяющегося чтения" и "фантомного чтения", но может привести к повышенной конкуренции и блокировкам, особенно в многопользовательских средах.

Выбор уровня изоляции в MySQL зависит от конкретных требований и характеристик приложения. Некоторые приложения могут требовать максимальной изоляции для обеспечения целостности данных, в то время как другие могут допускать некоторые компромиссы в пользу производительности.

### уровни блокировок;

В MySQL блокировки используются для управления доступом к данным и обеспечения изоляции транзакций. Существует несколько уровней блокировок, которые определяют, как и когда данные могут быть заблокированы и разблокированы другими транзакциями. Уровни блокировок в MySQL можно управлять с помощью различных команд и параметров.

Вот основные уровни блокировок в MySQL:

1. **READ UNCOMMITTED (Неизолированные чтение)**:
   - Этот уровень предоставляет минимальную изоляцию. Транзакция может читать данные, которые были изменены, но еще не зафиксированы.
   - Блокировки обычно не применяются к данным на этом уровне, что может привести к "грязному чтению" и другим проблемам.

2. **READ COMMITTED (Чтение фиксированной коммитности)**:
   - Транзакции блокируют строки только при чтении данных с целью избежать "грязного чтения".
   - Блокировки снимаются сразу после чтения данных, что может привести к "неповторяющемуся чтению" и "фантомному чтению".

3. **REPEATABLE READ (Повторяемое чтение)**:
   - При этом уровне блокировки данные, прочитанные одной транзакцией, блокируются до завершения этой транзакции, чтобы предотвратить изменение или удаление данных другими транзакциями.
   - Это предотвращает "неповторяющееся чтение" и снижает риск "фантомного чтения".

4. **SERIALIZABLE (Сериализуемое чтение)**:
   - Этот уровень предоставляет наибольшую степень изоляции. Каждый запрос на чтение блокирует все строки, с которыми он взаимодействует, до завершения транзакции.
   - Это предотвращает "грязное чтение", "неповторяющееся чтение" и "фантомное чтение", но может привести к повышенной конкуренции за блокировки.

Помимо уровней блокировок, MySQL также предоставляет инструменты и команды для управления блокировками на более детальном уровне, например, с помощью команды `LOCK TABLES` и различных функций и параметров, связанных с блокировками.

Выбор подходящего уровня блокировки в MySQL зависит от требований к изоляции транзакций, конкуренции за ресурсы и ожидаемой производительности приложения.

### управление транзакциями в mysql.

Управление транзакциями в MySQL включает в себя набор операций и команд, позволяющих разработчикам и администраторам баз данных контролировать выполнение и изоляцию транзакций. Вот основные команды и понятия, связанные с транзакциями в MySQL:

1. **START TRANSACTION**:
   - Эта команда начинает новую транзакцию. Все последующие SQL-операторы, выполненные в рамках этой сессии, считаются частью этой транзакции.

2. **COMMIT**:
   - Когда транзакция завершена и все операции были выполнены успешно, команда `COMMIT` фиксирует изменения, сделанные транзакцией, и сохраняет их в базе данных.

3. **ROLLBACK**:
   - Если в процессе выполнения транзакции возникают ошибки или необходимо отменить все изменения, команда `ROLLBACK` откатывает транзакцию и возвращает данные к состоянию до начала транзакции.

4. **SAVEPOINT**:
   - Команда `SAVEPOINT` позволяет установить точку сохранения внутри транзакции. Это позволяет выполнить частичный откат транзакции до указанной точки, минуя предыдущие операции.

5. **AUTOCOMMIT**:
   - По умолчанию в MySQL включен режим `AUTOCOMMIT`, который автоматически фиксирует каждую индивидуальную операцию как отдельную транзакцию. Этот режим можно отключить с помощью команды `SET AUTOCOMMIT=0;`, после чего нужно будет явно использовать команды `COMMIT` и `ROLLBACK` для управления транзакциями.

6. **Уровни изоляции транзакций**:
   - MySQL поддерживает различные уровни изоляции транзакций, такие как READ COMMITTED, REPEATABLE READ и SERIALIZABLE. Эти уровни определяют, как одна транзакция "видит" изменения, внесенные другими транзакциями, и какие блокировки применяются для обеспечения изоляции.

7. **Транзакции и блокировки**:
   - Транзакции в MySQL тесно связаны с управлением блокировками. При выполнении операций чтения и записи транзакция может блокировать определенные ресурсы (например, строки или таблицы) для предотвращения конфликтов с другими транзакциями.

Правильное управление транзакциями в MySQL играет ключевую роль в обеспечении целостности данных, избегании потерь данных и конфликтов при одновременном доступе к ресурсам.