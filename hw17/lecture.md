# Лекция #17

## Резервное копирование и восстановление

Резервное копирование и восстановление Postgresql

## Цели занятия

Резервное копирование и восстановление данных в PostgreSQL требует специфических инструментов и методик. Вот основные шаги для резервного копирования и восстановления данных в PostgreSQL:

### Резервное копирование в PostgreSQL:

1. **pg_dump**: Этот инструмент предоставляется в комплекте с PostgreSQL и позволяет создавать логические резервные копии баз данных или таблиц.

   Пример использования для резервного копирования одной базы данных:
   ```bash
   pg_dump dbname > backup.sql
   ```
   Для резервного копирования определенных таблиц:
   ```bash
   pg_dump dbname -t tablename > backup_table.sql
   ```

2. **pg_dumpall**: Этот инструмент используется для создания резервной копии всех баз данных, доступных пользователю.

   ```bash
   pg_dumpall > backup_all.sql
   ```

3. **pg_basebackup**: Для создания физической резервной копии, которая включает все данные, используйте этот инструмент.

   ```bash
   pg_basebackup -D /path/to/backup/directory -Ft -Xs -P -U username -h hostname
   ```

### Восстановление в PostgreSQL:

1. **pg_restore**: Для восстановления резервной копии, созданной с помощью `pg_dump`, используйте `pg_restore`.

   ```bash
   pg_restore -d dbname backup.sql
   ```

2. **pg_basebackup**: Для восстановления физической резервной копии, созданной с помощью `pg_basebackup`, остановите текущий экземпляр PostgreSQL и замените директорию данных на копию.

3. **Архивные журналы (WAL)**: Если вы делаете периодические резервные копии с использованием `pg_basebackup`, вам также нужно сохранять архивные журналы (WAL) для возможности восстановления до определенной точки во времени. Эти файлы могут быть восстановлены с помощью `pg_basebackup` с определенными параметрами или с помощью команды `pg_wal_replay`.

### Рекомендации:

- Регулярно проверяйте целостность и валидность резервных копий.
- Сохраняйте резервные копии в безопасном месте, предотвращая случайное удаление или повреждение.
- Тестируйте процедуру восстановления регулярно, чтобы убедиться в её работоспособности.

Помимо вышеупомянутых инструментов и методик, существуют сторонние решения и инструменты для резервного копирования и восстановления PostgreSQL, которые могут предложить дополнительные функции и упростить процесс управления резервными копиями.

### pg_basebackup;

Конечно, давайте рассмотрим подробнее инструмент `pg_basebackup` в PostgreSQL.

### Что такое `pg_basebackup`?

`pg_basebackup` — это утилита в PostgreSQL, которая позволяет создавать физические резервные копии (base backups) для целой кластерной установки PostgreSQL. Эти резервные копии содержат все данные, необходимые для восстановления кластера PostgreSQL, включая таблицы, индексы, а также журналы транзакций (WAL), которые позволяют применять изменения после резервного копирования.

### Как использовать `pg_basebackup`:

1. **Создание резервной копии**:

   Простейший способ создания резервной копии кластера PostgreSQL с использованием `pg_basebackup`:
   ```bash
   pg_basebackup -D /path/to/backup/directory -Ft -Xs -P -U username -h hostname
   ```

   Где:
    - `-D /path/to/backup/directory`: Путь к каталогу, где будет сохранена резервная копия.
    - `-Ft`: Формат резервной копии (тар-архив).
    - `-Xs`: Включение режима потоковой передачи WAL (Write-Ahead Logging).
    - `-P`: Отображение прогресса копирования.
    - `-U username`: Имя пользователя для подключения к PostgreSQL.
    - `-h hostname`: Имя хоста или IP-адрес сервера PostgreSQL.

2. **Восстановление из резервной копии**:

   После создания резервной копии вы можете использовать её для восстановления кластера PostgreSQL. Вам потребуется остановить текущий экземпляр PostgreSQL и заменить директорию данных (`PGDATA`) на копию, после чего запустить сервер снова.

3. **Архивные журналы (WAL)**:

   При использовании `pg_basebackup` в режиме с потоковой передачей WAL (`-Xs`), утилита также создаст каталог с архивными журналами. Эти журналы позволяют применять изменения к резервной копии, чтобы добиться последнего состояния данных на момент создания копии.

### Рекомендации:

- Регулярно создавайте резервные копии, особенно если ваши данные критически важны.
- Храните резервные копии в безопасном месте, отдельно от основного кластера PostgreSQL.
- Периодически проверяйте процедуру восстановления, чтобы убедиться в её эффективности.

`pg_basebackup` — это мощный инструмент, который предоставляет возможность создавать физические резервные копии PostgreSQL с высокой степенью надежности и гибкости.

### pg_probackup;

`pg_probackup` — это утилита для резервного копирования и восстановления данных в PostgreSQL, разработанная компанией Postgres Professional. Этот инструмент предоставляет расширенные функции и управление резервными копиями по сравнению с базовыми инструментами, встроенными в PostgreSQL.

### Основные особенности `pg_probackup`:

1. **Инкрементное резервное копирование**: Возможность создания инкрементных резервных копий, которые содержат только измененные данные с момента последнего полного или инкрементного резервного копирования.

2. **Параллельное резервное копирование**: `pg_probackup` может выполнять резервное копирование нескольких баз данных параллельно, что может ускорить процесс резервного копирования.

3. **Целостность и валидация**: Возможность проверки целостности резервных копий и восстановление данных с проверкой на ошибки.

4. **Резервное копирование WAL**: `pg_probackup` может автоматически архивировать и управлять файлами журнала транзакций (WAL), обеспечивая последовательность транзакций и возможность точного восстановления до определенной точки во времени.

5. **Управление многоверсионностью**: `pg_probackup` предоставляет возможности для работы с многоверсионными резервными копиями, позволяя вам сохранять исторические версии данных.

### Как использовать `pg_probackup`:

1. **Инициализация каталога резервного копирования**:
   ```bash
   pg_probackup init -B /path/to/backup/directory
   ```

2. **Создание резервной копии**:
   ```bash
   pg_probackup backup -B /path/to/backup/directory -D /path/to/data/directory
   ```

3. **Восстановление из резервной копии**:
   ```bash
   pg_probackup restore -B /path/to/backup/directory -D /path/to/restore/directory
   ```

### Рекомендации:

- **Тестирование**: Прежде чем использовать `pg_probackup` в производственной среде, рекомендуется провести тестирование в контролируемой среде, чтобы понять его функциональные возможности и особенности.

- **Документация**: Поскольку `pg_probackup` предоставляет множество функций, рекомендуется ознакомиться с официальной документацией и руководствами пользователя для глубокого понимания всех аспектов и возможностей инструмента.

В целом, `pg_probackup` представляет собой мощный инструмент для резервного копирования и восстановления PostgreSQL, который может быть особенно полезен в крупных и сложных окружениях баз данных.

### архивация журналов;

Архивация журналов (WAL — Write-Ahead Logging) — это механизм в системах управления базами данных (СУБД), который обеспечивает надежность и восстановимость данных. Прежде чем мы погрузимся в детали, давайте разберемся с основными понятиями.

### Основные понятия:

1. **Журналирование (Logging)**: Процесс записи изменений данных в специальные журнальные файлы до фактической записи изменений на диск.

2. **WAL-журналы**: Это специальные файлы, в которые СУБД записывает информацию о всех изменениях данных, происходящих в базе.

3. **Архивация**: Процесс сохранения старых WAL-журналов на отдельном, защищенном от доступа месте.

### Зачем нужна архивация журналов?

1. **Восстановление после сбоев**: Если возникнет сбой или ошибка, система может использовать архивные журналы для восстановления данных до момента сбоя.

2. **Резервное копирование**: Вместе с резервными копиями базы данных архивные журналы позволяют восстановить систему до конкретного момента времени.

3. **Репликация и резервирование**: Для систем репликации, кластеризации или отказоустойчивости архивация журналов обеспечивает синхронизацию данных между различными узлами.

### Процесс архивации в PostgreSQL:

1. **Настройка параметров**: В PostgreSQL существует параметр `archive_mode`, который определяет, следует ли архивировать WAL-журналы. С этим параметром также связаны другие настройки, например, `archive_command`, который указывает, куда и как копировать архивные журналы.

2. **Ручная архивация**: Вручную можно архивировать текущий активный WAL-журнал, отправив сигнал `SIGUSR1` процессу PostgreSQL. Это может быть полезно перед выполнением важных операций, требующих резервного копирования или снятия снимков.

3. **Автоматическая архивация**: С помощью соответствующей настройки `archive_mode` и `archive_command`, PostgreSQL может автоматически архивировать WAL-журналы, когда они становятся необходимыми.

### Рекомендации:

- **Безопасность**: Храните архивные журналы в безопасном месте, защищенном от утери данных и несанкционированного доступа.

- **Регулярность**: Определите частоту архивации в зависимости от требований к восстановлению данных. В некоторых критически важных системах архивация может происходить каждые несколько минут.

- **Мониторинг**: Регулярно мониторьте процесс архивации и состояние архивных журналов, чтобы убедиться в их доступности и целостности.

В целом, архивация журналов является критически важным аспектом обеспечения надежности и безопасности данных в системах управления базами данных, таких как PostgreSQL.

### barman.

`Barman` (Backup and Recovery Manager) — это инструмент для резервного копирования и восстановления PostgreSQL, разработанный для управления большими и сложными инфраструктурами баз данных. Barman предоставляет мощные и гибкие возможности для архивации и восстановления, а также управления WAL-журналами PostgreSQL.

### Основные особенности Barman:

1. **Централизованное управление**: Barman позволяет управлять резервными копиями для нескольких серверов PostgreSQL из одного места.

2. **Архивация WAL-журналов**: Barman автоматически архивирует WAL-журналы, обеспечивая надежность и возможность точного восстановления данных.

3. **Инкрементное резервное копирование**: Возможность создания инкрементных резервных копий, что позволяет экономить пространство и время.

4. **Многоверсионные резервные копии**: Barman позволяет сохранять и восстанавливать исторические версии резервных копий, что может быть полезно для отладки или анализа.

5. **Параллельное резервное копирование**: Barman может выполнять резервное копирование нескольких серверов одновременно, оптимизируя процесс резервного копирования.

### Основные шаги для использования Barman:

1. **Установка и настройка**: Сначала необходимо установить и настроить Barman на отдельной машине, которая будет использоваться для хранения резервных копий.

2. **Настройка серверов PostgreSQL**: Для каждого сервера PostgreSQL, который вы хотите резервно копировать с помощью Barman, настройте соответствующие параметры архивации WAL в PostgreSQL.

3. **Добавление серверов в Barman**: С помощью Barman добавьте серверы PostgreSQL в список управляемых серверов.

4. **Выполнение резервного копирования**: Запустите процесс резервного копирования для выбранных серверов с помощью Barman.

5. **Восстановление данных**: В случае необходимости восстановления данных, используйте Barman для восстановления резервной копии на соответствующем сервере PostgreSQL.

### Рекомендации:

- **Мониторинг и алерты**: Настройте мониторинг и оповещения для Barman, чтобы своевременно реагировать на любые проблемы или сбои в процессе резервного копирования.

- **Регулярные проверки**: Периодически проверяйте состояние резервных копий и архивных журналов, чтобы убедиться в их доступности и целостности.

- **Тестирование восстановления**: Регулярно проводите тесты восстановления данных, чтобы убедиться в эффективности процедур восстановления, основанных на резервных копиях, созданных с помощью Barman.

В целом, Barman представляет собой мощный инструмент для резервного копирования и восстановления PostgreSQL, который может быть особенно полезен в крупных и распределенных окружениях баз данных.